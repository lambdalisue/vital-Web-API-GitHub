let s:V = vital#of('vital')
let s:J = s:V.import('Web.JSON')
let s:G = s:V.import('Web.API.GitHub')
let s:P = s:V.import('System.Filepath')
let s:S = s:V.import('Vim.ScriptLocal')
let s:sv = s:S.svars(s:P.realpath(s:P.abspath(
      \ 'autoload/vital/__latest__/Web/API/GitHub.vim',
      \)))
let s:sf = s:S.sfuncs(s:P.realpath(s:P.abspath(
      \ 'autoload/vital/__latest__/Web/API/GitHub.vim',
      \)))

Describe Web.API.GitHub
  Context .get_config()
    It returns a config dictionary
      let ret = s:G.get_config()
      Assert IsDict(ret)
      Assert KeyExists(ret, 'baseurl')
      Assert KeyExists(ret, 'authorize_scopes')
      Assert KeyExists(ret, 'authorize_note')
      Assert KeyExists(ret, 'authorize_note_url')
      Assert KeyExists(ret, 'skip_authentication')
    End
  End

  Context .set_config({config})
    It overrides a config dictionary
      let old_config = s:G.get_config()
      let new_config = {
            \ 'baseurl': 'foobar',
            \ 'authorize_scopes': ['foo'],
            \ 'authorize_note': 'hello',
            \ 'authorize_note_url': 'hoge',
            \ 'skip_authentication': 1,
            \}
      try
        call s:G.set_config(new_config)
        let ret = s:G.get_config()
        Assert Equals(ret.baseurl, 'foobar')
        Assert Equals(ret.authorize_scopes, ['foo'])
        Assert Equals(ret.authorize_note, 'hello')
        Assert Equals(ret.authorize_note_url, 'hoge')
        Assert Equals(ret.skip_authentication, 1)
      finally
        call s:G.set_config(old_config)
      endtry
    End
  End

  Context .new({options})
    It returns a client object
      let ret = s:G.new()
      Assert IsDict(ret)
      Assert KeyExists(ret, 'baseurl')
      Assert KeyExists(ret, 'authorize_scopes')
      Assert KeyExists(ret, 'authorize_note')
      Assert KeyExists(ret, 'authorize_note_url')
      Assert KeyExists(ret, 'skip_authentication')
      " Public methods
      Assert KeyExists(ret, 'is_authorized')
      Assert KeyExists(ret, 'get_absolute_url')
      Assert KeyExists(ret, 'get_token')
      Assert KeyExists(ret, 'get_authorized_username')
      Assert KeyExists(ret, 'login')
      Assert KeyExists(ret, 'logout')
      Assert KeyExists(ret, 'request')
      Assert KeyExists(ret, 'get')
      Assert KeyExists(ret, 'post')
      Assert KeyExists(ret, 'put')
      Assert KeyExists(ret, 'patch')
      Assert KeyExists(ret, 'delete')
    End
  End

  Context [PRIVATE] s:_authorize({client}, {username}, {password}[, {options})
    Before
      let client = s:G.new()
      function! client.request(...) abort
        let self._request_args = a:000
        return {
              \ 'status': 200,
              \ 'statusText': 'success',
              \ 'content': '',
              \}
      endfunction
    End

    It request a personal access token to GitHub API
      let ret = s:sf._authorize(
            \ client,
            \ 'username',
            \ 'password', {
            \   'verbose': 0,
            \ },
            \)
      Assert Equals(ret, {
            \ 'status': 200,
            \ 'statusText': 'success',
            \ 'content': '',
            \})
      let args = client._request_args
      let data = s:J.encode({
            \ 'scopes': [],
            \ 'note': client.get_authorize_note(),
            \ 'note_url': '',
            \})
      Assert Equals(args, [{
            \ 'headers': {},
            \ 'method': 'POST',
            \ 'data': data,
            \ 'url': 'https://api.github.com/authorizations',
            \ 'username': 'username',
            \ 'password': 'password',
            \ 'authMethod': 'basic',
            \}])
    End

    It request a personal access token to GitHub API with {otp}
      let ret = s:sf._authorize(
            \ client,
            \ 'username',
            \ 'password', {
            \   'verbose': 0,
            \   'otp': '012345',
            \ },
            \)
      Assert Equals(ret, {
            \ 'status': 200,
            \ 'statusText': 'success',
            \ 'content': '',
            \})
      let args = client._request_args
      let data = s:J.encode({
            \ 'scopes': [],
            \ 'note': client.get_authorize_note(),
            \ 'note_url': '',
            \})
      Assert Equals(args, [{
            \ 'headers': {
            \   'X-GitHub-OTP': '012345',
            \ },
            \ 'method': 'POST',
            \ 'data': data,
            \ 'url': 'https://api.github.com/authorizations',
            \ 'username': 'username',
            \ 'password': 'password',
            \ 'authMethod': 'basic',
            \}])
    End
  End

  Context [PRIVATE] s:_authenticate({client}, {username}, {token}[, {options})
    Before
      let client = s:G.new()
      function! client.request(...) abort
        let self._request_args = a:000
        return {
              \ 'status': 200,
              \ 'statusText': 'success',
              \ 'content': '',
              \}
      endfunction
    End

    It confirm an authentication of {username} with {token}
      let ret = s:sf._authenticate(
            \ client,
            \ 'username',
            \ '012345', {
            \   'verbose': 0,
            \ }
            \)
      let args = client._request_args
      Assert Equals(args, [{
            \ 'headers': {
            \   'Authorization': 'token 012345',
            \ },
            \ 'param': {},
            \ 'method': 'GET',
            \ 'url': 'https://api.github.com/user',
            \}])
    End
  End
End
